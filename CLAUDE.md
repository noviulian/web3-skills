# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a collection of Claude Code skills for integrating with the Moralis Web3 API. It provides modular skills for querying blockchain data from both EVM (Ethereum, Polygon, BSC, etc.) and Solana networks, plus real-time event streaming.

**Zero-dependency architecture:** All code uses only Node.js built-in modules (https, fs, path, url, crypto). No npm packages are installed.

## Skills Architecture

```
skills/
├── moralis-data-api/       # Unified EVM + Solana data API (136 endpoints)
│   ├── rules/
│   │   ├── DataTransformations.md    # Pattern reference (manual)
│   │   ├── ResponsePatterns.md      # Pattern reference (manual)
│   │   └── CommonPitfalls.md       # Pattern reference (manual)
│   └── SKILL.md                 # Main skill with condensed patterns (60-70% of use cases)
└── moralis-streams-api/    # Real-time blockchain event streaming
    ├── rules/
    │   ├── StreamConfiguration.md  # Pattern reference (manual)
    │   └── CommonPitfalls.md       # Pattern reference (manual)
    └── SKILL.md                 # Main skill with condensed patterns (60-70% of use cases)
```

### Pattern Reference Files

Each skill includes pattern reference files containing complete reference material for common implementation patterns. These are **manually created** to provide better organization while maintaining critical content in SKILL.md.

**Important:** SKILL.md files contain condensed versions (60-70% of use cases) to reduce file size. Pattern files are for edge cases and complete reference. Always read SKILL.md first, then consult pattern files only when encountering complex/edge-case scenarios.

### moralis-data-api

- `rules/DataTransformations.md` - Complete type conversion and field mapping reference (block numbers, timestamps, balances, snake_case → camelCase)
- `rules/ResponsePatterns.md` - Complete pagination and response structure reference (4 pagination patterns with examples)
- `rules/CommonPitfalls.md` - Complete pitfalls and gotchas reference (data type assumptions, HTTP methods, path inconsistencies)

### moralis-streams-api

- `rules/StreamConfiguration.md` - Complete stream configuration reference (UUID format, chain IDs, topic0, status values, field mappings)
- `rules/CommonPitfalls.md` - Complete streams-specific pitfalls reference (HTTP methods, response structures, webhook payload differences)

**Note:** Pattern reference files are NOT auto-generated by the endpoint generator. They are manually maintained and will not be overwritten when running `node scripts/generate-endpoint-rules.js`.

## Development Commands

```bash
# Generate endpoint markdown rules from swagger config
node scripts/generate-endpoint-rules.js

# Extract endpoints from swagger documentation
node scripts/extract-endpoints.js

# Check for endpoint naming collisions
node scripts/check-collisions.js

# Validate Solana suffix naming (all Solana endpoints must have __solana)
node scripts/check-solana-suffix.js
```

## Source of Truth

`swagger/api-configs.json` defines all endpoints. The `generate-endpoint-rules.js` script:
1. Reads `api-configs.json`
2. Creates per-endpoint markdown files in `skills/*/rules/`
3. Updates SKILL.md files with endpoint catalogs

**Never edit individual rule files directly.** Edit `api-configs.json` and regenerate.

## Endpoint Naming Convention

- **Solana endpoints:** Always suffixed with `__solana` (e.g., `getWalletBalance__solana.md`)
- **EVM endpoints:** No suffix unless collision exists (then `__evm`)
- This convention is strictly enforced by the generator script

## Skill Frontmatter Pattern

All SKILL.md files use YAML frontmatter:

```yaml
---
name: skill-name
description: Single-line description
license: MIT
compatibility: Requires Node.js (built-in modules only)
metadata:
    version: "x.y.z"
    author: web3-skills
    tags: [web3, blockchain, ...]
context:
    fork: novnski/moralis-api-skills
    agent: claude-code
allowed-tools:
    - Bash
invocation:
    max-turns: 2
    disable-model: false
---
```

## Query Client Pattern

Query clients use REST APIs via Node.js `https` module. The pattern:

1. Accept API key from user input (stored in session memory)
2. Build URL with path/query params
3. Make HTTPS request with `X-API-Key` header
4. Handle pagination with `cursor` parameter
5. Return formatted results

**Note:** The API key is managed in-memory per session and shared between both skills. Users provide the key via natural language when using either skill.

## Pagination Pattern

Many endpoints support cursor-based pagination:

```bash
# First request
curl "...?limit=100"

# Next page (use cursor from response)
curl "...?limit=100&cursor=<cursor>"
```

## Environment Variable Discovery

Skills find the `.env` file by searching upward:

```javascript
// Priority 1: Project-level skills
<project>/.claude/skills/        → <project>/.claude/.env

// Priority 2: Global skills
~/.claude/skills/                → ~/.claude/.env

// Fallback
process.cwd()
```

## Adding New Endpoints

1. Add endpoint definition to `swagger/api-configs.json`
2. Run `node scripts/generate-endpoint-rules.js`
3. Verify rule file was created in `skills/*/rules/`
4. Test endpoint with curl before skill usage

## Testing

No automated test suite. Test via:
1. Direct curl commands with `$MORALIS_API_KEY`
2. Skill invocation with sample queries
3. Verify both EVM and Solana routing when applicable

## Supported Chains

**EVM:** eth, polygon, bsc, arbitrum, optimism, avalanche, fantom, base, and more (see `api-configs.json` for full enum)

**Solana:** mainnet, devnet
